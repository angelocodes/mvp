{% extends 'base.html' %}
{% load static %}

{% block title %}Project Detail - Analytical Method Validation MVP{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-8">
            <div class="card">
                <div class="card-header">
                    <h2 id="projectTitle"></h2>
                </div>
                <div class="card-body">
                    <div id="projectInfo">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading project...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Validation Steps</h3>
                </div>
                <div class="card-body">
                    <div id="workflowSteps" class="workflow-steps"></div>
                    <div id="validationContent"></div>
                </div>
            </div>
        </div>

        <div class="col-4">
            <div class="card">
                <div class="card-header">
                    <h3>Project Details</h3>
                </div>
                <div class="card-body" id="sidebarInfo">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div class="card" id="reviewCard" style="display: none;">
                <div class="card-header">
                    <h3>Review</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Comment</label>
                        <textarea id="reviewComment"></textarea>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="submitReview()">Submit Review</button>
                </div>
            </div>

            <div class="card" id="approveCard" style="display: none;">
                <div class="card-header">
                    <h3>QA Approval</h3>
                </div>
                <div class="card-body">
                    <button class="btn btn-success btn-block" onclick="approveProject()">Approve Project</button>
                    <button class="btn btn-danger btn-block mt-1" onclick="rejectProject()">Reject</button>
                </div>
            </div>

            <div class="card" id="reportCard" style="display: none;">
                <div class="card-header">
                    <h3>Validation Report</h3>
                </div>
                <div class="card-body">
                    <p id="reportStatus" style="margin-bottom: 15px; color: #6c757d;">No report generated yet</p>
                    <button class="btn btn-primary btn-block" id="generateReportBtn" onclick="generateReport()" style="display: none;">Generate Report</button>
                    <button class="btn btn-success btn-block" id="downloadReportBtn" onclick="downloadReport()" style="display: none; margin-top: 10px;">Download PDF Report</button>
                </div>
            </div>

            <div class="card" id="documentsCard" style="display: none;">
                <div class="card-header">
                    <h3>Supporting Documents</h3>
                </div>
                <div class="card-body">
                    <div id="documentsList">
                        <p style="color: #6c757d;">No documents uploaded yet</p>
                    </div>
                    <div id="uploadSection" style="margin-top: 15px; display: none;">
                        <hr style="margin: 15px 0;">
                        <h4 style="font-size: 14px; margin-bottom: 10px;">Upload New Document</h4>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <select id="docFileType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="other">Select document type...</option>
                                <option value="chromatogram">Chromatogram</option>
                                <option value="instrument_data">Instrument Data</option>
                                <option value="certificate">Certificate</option>
                                <option value="sop">SOP/Procedure</option>
                                <option value="raw_data">Raw Data</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <textarea id="docDescription" placeholder="Description (optional)" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 60px;"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <input type="file" id="docFileInput" accept=".pdf,.csv,.jpg,.jpeg,.png,.tiff,.txt,.xlsx,.docx" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #6c757d;">Max file size: 5MB. Allowed: PDF, CSV, Images, TXT, Excel, Word</small>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="uploadDocument()" id="uploadDocBtn">Upload Document</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Validation Result Modal -->
<div id="validationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Validation Result</h2>
            <button class="modal-close" onclick="closeValidationModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="validationResultContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeValidationModalAndRefresh()">Close</button>
            <button class="btn btn-primary" onclick="closeValidationModalAndRefresh()">Continue to Next Step</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const projectId = {{ project_id }};
    let projectData = null;

    async function loadProject() {
        try {
            // Get both project data and current user info
            const [{ data }, { data: currentUser }] = await Promise.all([
                api.getProject(projectId),
                api.getCurrentUser()
            ]);
            projectData = data;
            
            // Store current user in localStorage for role checking
            localStorage.setItem('current_user', JSON.stringify(currentUser));
            
            document.getElementById('projectTitle').textContent = data.method_name;
            
            let sidebarHTML = `
                <dl>
                    <dt>Status</dt>
                    <dd><span class="badge status-badge status-${data.status}">${data.status}</span></dd>
                    <dt>Product</dt>
                    <dd>${data.product_name}</dd>
                    <dt>Technique</dt>
                    <dd>${data.technique.toUpperCase()}</dd>
                    <dt>Created By</dt>
                    <dd>${data.created_by}</dd>
                    <dt>Created At</dt>
                    <dd>${Utils.formatDate(data.created_at)}</dd>
            `;
            if (data.reviewer) {
                sidebarHTML += `
                    <dt>Reviewer</dt>
                    <dd>${data.reviewer}</dd>
                `;
            }
            if (data.qa_approver) {
                sidebarHTML += `
                    <dt>QA Approver</dt>
                    <dd>${data.qa_approver}</dd>
                `;
            }
            sidebarHTML += '</dl>';
            
            document.getElementById('sidebarInfo').innerHTML = sidebarHTML;
            
            // Handle role-based card visibility
            handleRoleBasedCards(data, currentUser);

            let projectHTML = `
                <table class="info-table">
                    <tr>
                        <td>Method Type</td>
                        <td>${data.method_type}</td>
                    </tr>
                    <tr>
                        <td>Guideline</td>
                        <td>${data.guideline}</td>
                    </tr>
                    <tr>
                        <td>Current Status</td>
                        <td><span class="status-badge status-${data.status}">${data.status}</span></td>
                    </tr>
                </table>
            `;

            if (data.status === 'draft') {
                projectHTML += '<button class="btn btn-primary btn-block mt-3" onclick="startValidation()">Start Validation</button>';
            }

            document.getElementById('projectInfo').innerHTML = projectHTML;
            
            // Handle role-based card visibility
            handleRoleBasedCards(data, currentUser);
            
            // Handle report card visibility
            handleReportCard(data);
            
            // Load documents
            loadDocuments();
            
            loadWorkflowSteps();
        } catch (error) {
            console.error('Error loading project:', error);
        }
    }

    function handleRoleBasedCards(data, currentUser) {
        const reviewCard = document.getElementById('reviewCard');
        const approveCard = document.getElementById('approveCard');
        
        const userRole = currentUser.role;
        const projectStatus = data.status;
        
        // Show review card for reviewers/QA when project is in review status
        if (projectStatus === 'review' && (userRole === 'reviewer' || userRole === 'qa')) {
            reviewCard.style.display = 'block';
        } else {
            reviewCard.style.display = 'none';
        }
        
        // Show approve card for QA when project is reviewed and ready for approval
        if (projectStatus === 'review' && data.reviewer && userRole === 'qa') {
            approveCard.style.display = 'block';
        } else {
            approveCard.style.display = 'none';
        }
    }

    function handleReportCard(data) {
        const reportCard = document.getElementById('reportCard');
        const generateBtn = document.getElementById('generateReportBtn');
        const downloadBtn = document.getElementById('downloadReportBtn');
        const reportStatus = document.getElementById('reportStatus');
        
        // Show report card only for approved projects or projects that can generate reports
        if (data.status === 'approved' || data.report_generated) {
            reportCard.style.display = 'block';
            
            if (data.report_generated) {
                reportStatus.textContent = 'Report generated successfully';
                reportStatus.style.color = '#059669';
                generateBtn.style.display = 'none';
                downloadBtn.style.display = 'block';
            } else if (data.status === 'approved') {
                reportStatus.textContent = 'Ready to generate validation report';
                reportStatus.style.color = '#0891b2';
                generateBtn.style.display = 'block';
                downloadBtn.style.display = 'none';
            }
        } else {
            reportCard.style.display = 'none';
        }
    }

    async function generateReport() {
        try {
            const { status, data } = await api.generateReport(projectId);
            if (status === 200) {
                Utils.showSuccess('Report generated successfully!');
                // Refresh project data to update report status
                loadProject();
            } else {
                Utils.showError(data.error || 'Error generating report');
            }
        } catch (error) {
            console.error('Error generating report:', error);
            Utils.showError('Error generating report');
        }
    }

    function downloadReport() {
        const downloadUrl = api.downloadReport(projectId);
        // Open in new tab or trigger download
        window.open(downloadUrl, '_blank');
        Utils.showSuccess('Downloading report...');
    }

    async function loadDocuments() {
        try {
            const { status, data } = await api.getDocuments(projectId);
            const documentsCard = document.getElementById('documentsCard');
            const documentsList = document.getElementById('documentsList');
            const uploadSection = document.getElementById('uploadSection');
            
            // Show documents card for all projects that are not draft
            if (projectData && projectData.status !== 'draft') {
                documentsCard.style.display = 'block';
                
                // Show upload section only if project is not approved (locked)
                const userRole = Utils.getUserRole();
                if (projectData.status !== 'approved' && (userRole === 'analyst' || userRole === 'reviewer' || userRole === 'qa')) {
                    uploadSection.style.display = 'block';
                } else {
                    uploadSection.style.display = 'none';
                }
                
                if (status === 200 && data && data.length > 0) {
                    let html = '<div class="documents-grid">';
                    data.forEach(doc => {
                        const fileSize = (doc.file_size / 1024).toFixed(1);
                        const sizeUnit = doc.file_size > 1024 ? 'MB' : 'KB';
                        const displaySize = doc.file_size > 1024 ? (doc.file_size / 1024 / 1024).toFixed(2) + ' MB' : fileSize + ' KB';
                        
                        html += `
                            <div class="document-item">
                                <div class="document-header">
                                    <div class="document-info">
                                        <div class="document-name">${doc.file_name}</div>
                                        <div class="document-meta">
                                            <span style="text-transform: capitalize;">${doc.file_type.replace('_', ' ')}</span> ‚Ä¢ ${displaySize} ‚Ä¢ Uploaded by ${doc.uploaded_by}
                                        </div>
                                        ${doc.description ? `<div class="document-description">${doc.description}</div>` : ''}
                                        <div class="document-date">${Utils.formatDate(doc.uploaded_at)}</div>
                                    </div>
                                    <div class="document-actions">
                                        <a href="${doc.file_url}" target="_blank" class="btn btn-sm btn-outline-primary">Download</a>
                                        ${Utils.hasRole('qa') || doc.uploaded_by === Utils.getCurrentUser()?.username ? 
                                            `<button onclick="deleteDocument(${doc.id})" class="btn btn-sm btn-outline-danger">Delete</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    documentsList.innerHTML = html;
                } else {
                    documentsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÑ</div><div class="empty-state-title">No Documents</div><div class="empty-state-description">Supporting documents will appear here once uploaded.</div></div>';
                }
            } else {
                documentsCard.style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading documents:', error);
        }
    }

    async function uploadDocument() {
        const fileInput = document.getElementById('docFileInput');
        const fileType = document.getElementById('docFileType').value;
        const description = document.getElementById('docDescription').value;
        const uploadBtn = document.getElementById('uploadDocBtn');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            Utils.showError('Please select a file to upload');
            return;
        }
        
        if (fileType === 'other' && document.getElementById('docFileType').selectedIndex === 0) {
            Utils.showError('Please select a document type');
            return;
        }
        
        const file = fileInput.files[0];
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            Utils.showError('File size exceeds 5MB limit');
            return;
        }
        
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        
        try {
            const { status, data } = await api.uploadDocument(projectId, file, fileType, description);
            if (status === 201) {
                Utils.showSuccess('Document uploaded successfully!');
                // Clear form
                fileInput.value = '';
                document.getElementById('docDescription').value = '';
                document.getElementById('docFileType').selectedIndex = 0;
                // Reload documents
                loadDocuments();
            } else {
                Utils.showError(data.error || 'Error uploading document');
            }
        } catch (error) {
            console.error('Error uploading document:', error);
            Utils.showError('Error uploading document. Please try again.');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload Document';
        }
    }

    async function deleteDocument(documentId) {
        if (!confirm('Are you sure you want to delete this document?')) {
            return;
        }
        
        try {
            const { status, data } = await api.deleteDocument(projectId, documentId);
            if (status === 200) {
                Utils.showSuccess('Document deleted successfully');
                loadDocuments();
            } else {
                Utils.showError(data.error || 'Error deleting document');
            }
        } catch (error) {
            console.error('Error deleting document:', error);
            Utils.showError('Error deleting document');
        }
    }

    function loadWorkflowSteps() {
        const steps = ['Linearity', 'Accuracy', 'Precision', 'LOD/LOQ'];
        const statuses = ['linearity', 'accuracy', 'precision', 'lod_loq'];

        // Define workflow progression order
        const workflowOrder = ['draft', 'linearity', 'accuracy', 'precision', 'lod_loq', 'review', 'approved'];
        const currentStatusIndex = workflowOrder.indexOf(projectData.status);

        let stepsHTML = '';
        statuses.forEach((status, index) => {
            let stepClass = 'step';
            let stepIcon = '‚óã';
            let stepLabel = 'Pending';
            const stepStatusIndex = workflowOrder.indexOf(status);

            if (projectData.status === status) {
                stepClass += ' active'; // Currently working on this step
                stepIcon = '‚ñ∂';
                stepLabel = 'In Progress';
            } else if (currentStatusIndex > stepStatusIndex) {
                stepClass += ' completed'; // This step is completed
                stepIcon = '‚úì';
                stepLabel = 'Completed ‚úì';
            }
            // Otherwise, it's pending (default styling)

            stepsHTML += `
                <div class="${stepClass}">
                    <div class="step-name">${steps[index]}</div>
                    <div class="step-status">${stepLabel}</div>
                </div>
            `;
        });
        document.getElementById('workflowSteps').innerHTML = stepsHTML;
        loadValidationContent();
    }

    function loadValidationContent() {
        const status = projectData.status;
        let contentHTML = '';

        if (status === 'draft') {
            contentHTML = '<p style="color: #6c757d;">Start validation to begin entering data.</p>';
        } else if (status === 'linearity') {
            contentHTML = getLinearityForm();
        } else if (status === 'accuracy') {
            contentHTML = getAccuracyForm();
        } else if (status === 'precision') {
            contentHTML = getPrecisionForm();
        } else if (status === 'lod_loq') {
            contentHTML = getLODLOQForm();
        } else if (['review', 'approved'].includes(status)) {
            contentHTML = '<p style="color: #6c757d;">All validation steps completed. Awaiting review.</p>';
        }

        document.getElementById('validationContent').innerHTML = contentHTML;
    }

    function getLinearityForm() {
        // Check if this step has been attempted before and failed
        const hasFailedAttempt = checkForFailedAttempts('linearity');

        let formHeader = `
            <div class="data-entry-section">
                <h4>Linearity Test</h4>
                <div class="alert alert-info">
                    <strong>Instructions:</strong> Enter concentration levels and corresponding instrument responses.
                    Ensure all data is accurate and complete before submission.
                </div>
        `;

        if (hasFailedAttempt) {
            formHeader += `
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Previous Attempt Failed:</strong> This validation step failed in a previous attempt.
                    <a href="/re-analysis/?project=${projectId}&step=linearity" class="btn btn-sm btn-warning">Request Re-Analysis</a>
                </div>
            `;
        }

        const formContent = `
            <div class="form-group">
                <label>Concentrations (comma-separated) *</label>
                <input type="text" id="concentrations" placeholder="e.g., 50, 75, 100, 125, 150" required oninput="validateForm()">
                <small>Enter concentration values in Œºg/mL</small>
            </div>

            <div class="form-group">
                <label>Responses (comma-separated) *</label>
                <input type="text" id="responses" placeholder="e.g., 5000, 7500, 10000, 12500, 15000" required oninput="validateForm()">
                <small>Enter peak area or instrument response values</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="dataComplete" onchange="validateForm()">
                    I confirm that all data entered is complete, accurate, and ready for submission
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="acknowledgeWarnings" onchange="validateForm()">
                    I acknowledge and understand any system warnings or requirements
                </label>
            </div>

            <button class="btn btn-primary" onclick="submitLinearity()" id="submitBtn" disabled>Submit Linearity</button>
            <div id="linearityResult"></div>
        </div>`;

        return formHeader + formContent;
    }

    function getAccuracyForm() {
        return `
            <div class="data-entry-section">
                <h4>Accuracy Test (Recovery Testing)</h4>
                <div class="alert alert-info">
                    <strong>Instructions:</strong> Test at three concentration levels (80%, 100%, 120%). 
                    Enter the measured values and the recovery will be calculated automatically.
                </div>
                <div class="form-group">
                    <label>Accuracy Level *</label>
                    <select id="accuracyLevel" required>
                        <option value="">Select level</option>
                        <option value="80">80% (Low)</option>
                        <option value="100">100% (Medium)</option>
                        <option value="120">120% (High)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Measured Values (comma-separated) *</label>
                    <input type="text" id="measuredValues" placeholder="e.g., 98.5, 99.2, 98.8" required>
                    <small>Enter recovery % values for each replicate (minimum 3)</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="accuracyConfirm" onchange="validateForm()">
                        I confirm that all accuracy data is complete and accurate
                    </label>
                </div>
                <button class="btn btn-primary" onclick="submitAccuracy()" id="accuracySubmitBtn" disabled>Submit Accuracy</button>
                <div id="accuracyResult"></div>
            </div>
        `;
    }

    async function submitAccuracy() {
        const level = document.getElementById('accuracyLevel').value;
        const measured_values = document.getElementById('measuredValues').value.split(',').map(Number);

        try {
            const { status, data } = await api.submitAccuracy(projectId, level, measured_values);
            if (status === 200) {
                const result = Utils.parseValidationResponse(data);
                showValidationModal(result, 'Accuracy');
                Utils.showSuccess('Accuracy submitted successfully! Data is now locked and cannot be modified.');
            }
        } catch (error) {
            Utils.showError('Error submitting accuracy');
        }
    }

    function getPrecisionForm() {
        return `
            <div class="data-entry-section">
                <h4>Precision Test (Repeatability)</h4>
                <div class="alert alert-info">
                    <strong>Instructions:</strong> Prepare multiple replicates of the standard solution at 100% concentration.
                    Enter the measured values for each replicate.
                </div>
                <div class="form-group">
                    <label>Replicate Values (comma-separated) *</label>
                    <input type="text" id="replicateValues" placeholder="e.g., 99.8, 100.2, 99.5, 100.1, 99.9" required>
                    <small>Enter peak area or response values for each replicate (minimum 6)</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="precisionConfirm" onchange="validateForm()">
                        I confirm that all precision data is complete and accurate
                    </label>
                </div>
                <button class="btn btn-primary" onclick="submitPrecision()" id="precisionSubmitBtn" disabled>Submit Precision</button>
                <div id="precisionResult"></div>
            </div>
        `;
    }

    async function submitPrecision() {
        const replicate_values = document.getElementById('replicateValues').value.split(',').map(Number);

        try {
            const { status, data } = await api.submitPrecision(projectId, replicate_values);
            if (status === 200) {
                const result = Utils.parseValidationResponse(data);
                showValidationModal(result, 'Precision');
                Utils.showSuccess('Precision submitted successfully! Data is now locked and cannot be modified.');
            }
        } catch (error) {
            Utils.showError('Error submitting precision');
        }
    }

    function getLODLOQForm() {
        return `
            <div class="data-entry-section">
                <h4>LOD/LOQ Determination</h4>
                <div class="alert alert-info">
                    <strong>Instructions:</strong> Analyze blank samples and calculate LOD/LOQ based on signal-to-noise ratio.
                    Enter the blank responses and the method slope.
                </div>
                <div class="form-group">
                    <label>Blank Responses (comma-separated) *</label>
                    <input type="text" id="blankResponses" placeholder="e.g., 50, 45, 52, 48, 51" required>
                    <small>Enter instrument response values for blank samples (minimum 5)</small>
                </div>
                <div class="form-group">
                    <label>Method Slope (from Linearity) *</label>
                    <input type="number" id="methodSlope" placeholder="e.g., 100.5" step="0.1" required>
                    <small>Enter the slope value from the linearity test</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="lodloqConfirm" onchange="validateForm()">
                        I confirm that all LOD/LOQ data is complete and accurate
                    </label>
                </div>
                <button class="btn btn-primary" onclick="submitLODLOQ()" id="lodloqSubmitBtn" disabled>Submit LOD/LOQ</button>
                <div id="lodloqResult"></div>
            </div>
        `;
    }

    async function submitLODLOQ() {
        const blank_responses = document.getElementById('blankResponses').value.split(',').map(Number);
        const slope = parseFloat(document.getElementById('methodSlope').value);

        try {
            const { status, data } = await api.submitLODLOQ(projectId, blank_responses, slope);
            if (status === 200) {
                const result = Utils.parseValidationResponse(data);
                showValidationModal(result, 'LOD/LOQ');
                Utils.showSuccess('LOD/LOQ submitted successfully! Data is now locked and cannot be modified.');
            }
        } catch (error) {
            Utils.showError('Error submitting LOD/LOQ');
        }
    }

    async function startValidation() {
        try {
            const { status } = await api.startValidation(projectId);
            if (status === 200) {
                Utils.showSuccess('Validation started!');
                loadProject();
            }
        } catch (error) {
            Utils.showError('Error starting validation');
        }
    }

    async function submitReview() {
        const comment = document.getElementById('reviewComment').value;
        try {
            const { status } = await api.reviewProject(projectId, comment);
            if (status === 200) {
                Utils.showSuccess('Review submitted!');
                setTimeout(() => loadProject(), 1500);
            }
        } catch (error) {
            Utils.showError('Error submitting review');
        }
    }

    async function approveProject() {
        try {
            const { status } = await api.approveProject(projectId);
            if (status === 200) {
                Utils.showSuccess('Project approved!');
                setTimeout(() => loadProject(), 1500);
            }
        } catch (error) {
            Utils.showError('Error approving project');
        }
    }

    function rejectProject() {
        Utils.showError('Rejection feature coming soon');
    }

    function validateForm() {
        const status = projectData.status;
        let isDataValid = false;
        let submitBtn = null;
        let buttonText = 'Complete all fields and confirmations to submit';

        if (status === 'linearity') {
            const concentrations = document.getElementById('concentrations')?.value.trim() || '';
            const responses = document.getElementById('responses')?.value.trim() || '';
            const dataComplete = document.getElementById('dataComplete')?.checked;
            const acknowledgeWarnings = document.getElementById('acknowledgeWarnings')?.checked;
            submitBtn = document.getElementById('submitBtn');

            const concArray = concentrations.split(',').map(s => s.trim()).filter(s => s !== '');
            const respArray = responses.split(',').map(s => s.trim()).filter(s => s !== '');

            isDataValid = concArray.length >= 3 && respArray.length >= 3 &&
                         concArray.length === respArray.length &&
                         concArray.every(c => !isNaN(c) && c > 0) &&
                         respArray.every(r => !isNaN(r) && r > 0);

            buttonText = 'Submit Linearity';
            if (submitBtn) submitBtn.disabled = !(isDataValid && dataComplete && acknowledgeWarnings);
        } 
        else if (status === 'accuracy') {
            const level = document.getElementById('accuracyLevel')?.value;
            const measuredValues = document.getElementById('measuredValues')?.value.trim() || '';
            const accuracyConfirm = document.getElementById('accuracyConfirm')?.checked;
            submitBtn = document.getElementById('accuracySubmitBtn');

            const valueArray = measuredValues.split(',').map(s => s.trim()).filter(s => s !== '');
            isDataValid = level && valueArray.length >= 3 &&
                         valueArray.every(v => !isNaN(v) && v > 0);

            buttonText = 'Submit Accuracy';
            if (submitBtn) submitBtn.disabled = !(isDataValid && accuracyConfirm);
        }
        else if (status === 'precision') {
            const replicateValues = document.getElementById('replicateValues')?.value.trim() || '';
            const precisionConfirm = document.getElementById('precisionConfirm')?.checked;
            submitBtn = document.getElementById('precisionSubmitBtn');

            const valueArray = replicateValues.split(',').map(s => s.trim()).filter(s => s !== '');
            isDataValid = valueArray.length >= 6 &&
                         valueArray.every(v => !isNaN(v) && v > 0);

            buttonText = 'Submit Precision';
            if (submitBtn) submitBtn.disabled = !(isDataValid && precisionConfirm);
        }
        else if (status === 'lod_loq') {
            const blankResponses = document.getElementById('blankResponses')?.value.trim() || '';
            const methodSlope = document.getElementById('methodSlope')?.value.trim() || '';
            const lodloqConfirm = document.getElementById('lodloqConfirm')?.checked;
            submitBtn = document.getElementById('lodloqSubmitBtn');

            const valueArray = blankResponses.split(',').map(s => s.trim()).filter(s => s !== '');
            isDataValid = valueArray.length >= 5 &&
                         valueArray.every(v => !isNaN(v) && v >= 0) &&
                         !isNaN(methodSlope) && methodSlope > 0;

            buttonText = 'Submit LOD/LOQ';
            if (submitBtn) submitBtn.disabled = !(isDataValid && lodloqConfirm);
        }

        // Update button text if it exists
        if (submitBtn) {
            submitBtn.textContent = submitBtn.disabled ?
                'Complete all fields and confirmations to submit' : buttonText;
        }

        return isDataValid;
    }

    function handleFileSelect(event) {
        const files = event.target.files;
        const fileList = document.getElementById('fileList');

        if (files.length === 0) {
            fileList.innerHTML = '';
            return;
        }

        let html = '<div style="margin-top: 10px;"><strong>Selected files:</strong><ul>';
        Array.from(files).forEach((file, index) => {
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            html += `<li>${file.name} (${fileSize} MB)</li>`;
        });
        html += '</ul></div>';

        fileList.innerHTML = html;
    }

    async function submitLinearity() {
        if (!validateForm()) {
            Utils.showError('Please complete all required fields and confirmations');
            return;
        }

        const concentrations = document.getElementById('concentrations').value.split(',').map(s => parseFloat(s.trim()));
        const responses = document.getElementById('responses').value.split(',').map(s => parseFloat(s.trim()));

        // Validate arrays are equal length and contain valid numbers
        if (concentrations.length !== responses.length) {
            Utils.showError('Concentrations and responses must have the same number of values');
            return;
        }

        if (concentrations.some(isNaN) || responses.some(isNaN)) {
            Utils.showError('All values must be valid numbers');
            return;
        }

        try {
            const { status, data } = await api.submitLinearity(projectId, concentrations, responses);
            if (status === 200) {
                const result = Utils.parseValidationResponse(data);
                showValidationModal(result);
                Utils.showSuccess('Linearity submitted successfully! Data is now locked and cannot be modified.');
            } else if (status === 400) {
                Utils.showError(data.error || 'Error submitting linearity data');
            } else {
                console.error('Unexpected status:', status, 'Data:', data);
                Utils.showError(`Server error (status ${status}): ${data.error || 'Please try again'}`);
            }
        } catch (error) {
            console.error('Error submitting linearity:', error);
            Utils.showError('Network error or server not responding. Please check console for details.');
        }
    }

    function showValidationModal(result, stepName = 'Linearity') {
        const modal = document.getElementById('validationModal');
        const content = document.getElementById('validationResultContent');

        // Create enhanced result display
        content.innerHTML = `
            <div class="validation-result-modal">
                <div class="result-header">
                    <h3>${stepName} Validation Result: <span class="status-badge status-${result.status.toLowerCase()}">${result.status}</span></h3>
                </div>
                <div class="result-metrics">
                    <h4>Calculated Metrics:</h4>
                    <div class="metrics-grid">
                        ${Object.entries(result.metrics).map(([key, value]) => `
                            <div class="metric-item">
                                <span class="metric-label">${key.replace('_', ' ').toUpperCase()}:</span>
                                <span class="metric-value">${typeof value === 'number' ? value.toFixed(4) : value}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="result-justification">
                    <h4>ICH Q2(R1) Compliance Check:</h4>
                    <div class="justification-content">
                        ${result.justification.split('; ').map(item => `<p>‚úì ${item}</p>`).join('')}
                    </div>
                </div>
                ${result.status === 'PASS' ?
                    '<div class="alert alert-success"><strong>‚úÖ Passed:</strong> Data meets pharmaceutical validation requirements. Proceeding to next step.</div>' :
                    '<div class="alert alert-danger"><strong>‚ùå Failed:</strong> Data does not meet ICH Q2 requirements. Re-analysis may be required.</div>'
                }
            </div>
        `;

        modal.classList.add('show');
    }

    function closeValidationModal() {
        document.getElementById('validationModal').classList.remove('show');
    }

    function closeValidationModalAndRefresh() {
        closeValidationModal();
        loadProject(); // Refresh the page to show updated workflow
    }

    function checkForFailedAttempts(step) {
        // For now, return false - in a real implementation, this would check the API
        // for previous failed attempts for this step
        return false;
    }

    function logout() {
        api.logout();
        window.location.href = '/login/';
    }

    loadProject();
</script>
{% endblock %}
