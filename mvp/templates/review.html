{% extends 'base.html' %}
{% load static %}

{% block title %}Review Projects - Analytical Method Validation MVP{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2>Projects Pending Review</h2>
                    <small>As Reviewer, you verify data integrity, validate calculations, and ensure compliance</small>
                </div>
                <div class="card-body">
                    <div id="projectsList" style="min-height: 200px;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading projects...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project Review Modal -->
<div id="reviewModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2>Project Review: <span id="reviewProjectTitle"></span></h2>
            <button class="modal-close" onclick="closeReviewModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="reviewContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading project details...</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReviewModal()">Close</button>
            <button class="btn btn-success" onclick="submitFinalReview()" id="submitReviewBtn" disabled>Submit Final Review</button>
        </div>
    </div>
</div>

<!-- Parameter Review Modal -->
<div id="parameterModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="parameterTitle">Parameter Review</h2>
            <button class="modal-close" onclick="closeParameterModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="parameterContent"></div>
            <div class="form-group">
                <label>Review Decision *</label>
                <select id="parameterDecision" onchange="onParameterDecisionChange()">
                    <option value="">Select decision</option>
                    <option value="approve">‚úÖ Approve - Meets requirements</option>
                    <option value="reject">‚ùå Reject - Does not meet requirements</option>
                    <option value="correction">üîß Request Correction - Minor issues</option>
                </select>
            </div>
            <div class="form-group">
                <label>Comments *</label>
                <textarea id="parameterComments" rows="4" placeholder="Provide detailed review comments and justification..."></textarea>
            </div>
            <div id="deviationSection" style="display: none;">
                <div class="alert alert-warning">
                    <h4>Deviation Assessment</h4>
                    <p>Failure requires deviation analysis:</p>
                </div>
                <div class="form-group">
                    <label>Deviation Impact</label>
                    <select id="deviationImpact">
                        <option value="">Select impact</option>
                        <option value="minor">Minor - No impact on method validity</option>
                        <option value="major">Major - Requires re-validation</option>
                        <option value="critical">Critical - Method invalid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Recommended Action</label>
                    <select id="recommendedAction">
                        <option value="">Select action</option>
                        <option value="accept">Accept deviation with conditions</option>
                        <option value="rerun">Require re-analysis</option>
                        <option value="escalate">Escalate to QA</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeParameterModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitParameterReview()">Submit Review</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentProject = null;
    let parameterReviews = {};
    let validationSummary = null;
    let currentParameterName = null;

    async function loadProjects() {
        try {
            const { data: projects } = await api.getProjects();
            const reviewProjects = projects.filter(p => p.status === 'review');

            if (reviewProjects.length === 0) {
                document.getElementById('projectsList').innerHTML = `
                    <div class="alert alert-info">
                        <h4>No Projects Pending Review</h4>
                        <p>All projects have been reviewed or are still in validation phase.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="review-stats">
                    <div class="stat-item">
                        <span class="stat-number">${reviewProjects.length}</span>
                        <span class="stat-label">Projects Awaiting Review</span>
                    </div>
                </div>
                <table class="review-table">
                    <thead>
                        <tr>
                            <th>Project Details</th>
                            <th>Validation Status</th>
                            <th>Priority</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            reviewProjects.forEach(project => {
                const priority = getReviewPriority(project);
                html += `
                    <tr>
                        <td>
                            <div class="project-info">
                                <strong>${project.method_name}</strong><br>
                                <small>Product: ${project.product_name} | Technique: ${project.technique.toUpperCase()}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge status-badge status-${project.status}">${project.status}</span>
                        </td>
                        <td>
                            <span class="priority-badge priority-${priority.level}">${priority.label}</span>
                        </td>
                        <td>${Utils.formatDate(project.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openReviewModal(${project.id})">
                                Start Review
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('projectsList').innerHTML = html;
        } catch (error) {
            console.error('Error loading projects:', error);
            document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">Error loading projects</div>';
        }
    }

    function getReviewPriority(project) {
        // Calculate review priority based on project age and complexity
        const age = new Date() - new Date(project.created_at);
        const daysOld = age / (1000 * 60 * 60 * 24);

        if (daysOld > 7) return { level: 'high', label: 'High' };
        if (daysOld > 3) return { level: 'medium', label: 'Medium' };
        return { level: 'low', label: 'Low' };
    }

    async function openReviewModal(projectId) {
        currentProject = null;
        parameterReviews = {};
        validationSummary = null;
        currentParameterName = null;

        try {
            // Load project details and validation summary in parallel
            const [projectResponse, summaryResponse] = await Promise.all([
                api.getProject(projectId),
                api.getValidationSummary(projectId)
            ]);

            currentProject = projectResponse.data;
            validationSummary = summaryResponse.data;

            document.getElementById('reviewProjectTitle').textContent = currentProject.method_name;

            const reviewContent = await buildReviewInterface(currentProject);
            document.getElementById('reviewContent').innerHTML = reviewContent;

            // Load data verification and parameter reviews asynchronously
            loadDataVerification(currentProject);
            loadParameterReviews(currentProject);

            document.getElementById('reviewModal').classList.add('show');
        } catch (error) {
            console.error('Error loading project for review:', error);
            Utils.showError('Error loading project details: ' + (error.message || 'Unknown error'));
        }
    }

    async function buildReviewInterface(project) {
        return `
            <div class="review-header">
                <div class="project-summary">
                    <h3>Project Summary</h3>
                    <dl>
                        <dt>Analyst:</dt><dd>${project.created_by}</dd>
                        <dt>Product:</dt><dd>${project.product_name}</dd>
                        <dt>Technique:</dt><dd>${project.technique.toUpperCase()}</dd>
                        <dt>Guideline:</dt><dd>${project.guideline.toUpperCase()}</dd>
                        <dt>Submitted:</dt><dd>${Utils.formatDate(project.created_at)}</dd>
                    </dl>
                </div>
            </div>

            <div class="review-sections">
                <div class="review-section">
                    <h4>Data Verification</h4>
                    <div id="dataVerificationContent">
                        <div class="loading">Loading validation data...</div>
                    </div>
                </div>

                <div class="review-section">
                    <h4>Parameter Reviews</h4>
                    <div id="parameterReviewsContent">
                        <div class="loading">Loading validation steps...</div>
                    </div>
                </div>

                <div class="review-section">
                    <h4>Final Assessment</h4>
                    <div class="form-group">
                        <label>Overall Review Decision *</label>
                        <select id="finalDecision" onchange="onFinalDecisionChange()">
                            <option value="">Select final decision</option>
                            <option value="approve">‚úÖ APPROVE - All parameters meet requirements</option>
                            <option value="reject">‚ùå REJECT - Major issues require re-validation</option>
                            <option value="conditional">‚ö†Ô∏è CONDITIONAL - Approve with conditions</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Final Review Comments *</label>
                        <textarea id="finalComments" rows="4" placeholder="Provide comprehensive review summary, recommendations, and any conditions for approval..."></textarea>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="confirmCompliance" onchange="onFinalDecisionChange()">
                            I confirm this review ensures ICH Q2(R1) compliance and data integrity
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="acknowledgeResponsibility" onchange="onFinalDecisionChange()">
                            I acknowledge my responsibility for this scientific and technical assessment
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadDataVerification(project) {
        try {
            const content = `
                <div class="verification-checklist">
                    <h5>Data Integrity Verification</h5>
                    <div class="checklist-item">
                        <input type="checkbox" id="verify_sample_prep">
                        <label for="verify_sample_prep">Sample preparation procedures documented and appropriate</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="verify_concentrations">
                        <label for="verify_concentrations">Concentration levels cover appropriate range and include blanks</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="verify_replicates">
                        <label for="verify_replicates">Appropriate number of replicates (‚â•3) for statistical validity</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="verify_calculations">
                        <label for="verify_calculations">All calculations performed correctly using validated formulas</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="verify_outliers">
                        <label for="verify_outliers">No unexplained outliers or anomalous data points</label>
                    </div>
                </div>
            `;
            document.getElementById('dataVerificationContent').innerHTML = content;
        } catch (error) {
            console.error('Error loading data verification:', error);
            document.getElementById('dataVerificationContent').innerHTML = 
                '<div class="alert alert-danger">Error loading verification checklist</div>';
        }
    }

    async function loadParameterReviews(project) {
        try {
            if (!validationSummary || !validationSummary.validation_steps) {
                document.getElementById('parameterReviewsContent').innerHTML = 
                    '<div class="alert alert-warning">No validation data available for this project</div>';
                return;
            }

            const steps = validationSummary.validation_steps;
            const parameters = [];

            // Map validation steps to review cards
            if (steps.linearity) {
                const linearityData = steps.linearity.data || {};
                parameters.push({
                    name: 'Linearity',
                    key: 'linearity',
                    status: steps.linearity.passed ? 'PASS' : 'FAIL',
                    details: steps.linearity.completed 
                        ? `r¬≤ = ${(linearityData.r_squared || 0).toFixed(4)}, slope = ${(linearityData.slope || 0).toFixed(2)}`
                        : 'Not completed',
                    completed: steps.linearity.completed,
                    data: linearityData
                });
            }

            if (steps.accuracy) {
                const accuracyData = steps.accuracy.data || {};
                parameters.push({
                    name: 'Accuracy',
                    key: 'accuracy',
                    status: steps.accuracy.passed ? 'PASS' : 'FAIL',
                    details: steps.accuracy.completed
                        ? `Recovery: ${(accuracyData.mean_recovery || 0).toFixed(1)}%, RSD: ${(accuracyData.rsd || 0).toFixed(1)}%`
                        : 'Not completed',
                    completed: steps.accuracy.completed,
                    data: accuracyData
                });
            }

            if (steps.precision) {
                const precisionData = steps.precision.data || {};
                parameters.push({
                    name: 'Precision',
                    key: 'precision',
                    status: steps.precision.passed ? 'PASS' : 'FAIL',
                    details: steps.precision.completed
                        ? `RSD: ${(precisionData.rsd || 0).toFixed(1)}%, Mean: ${(precisionData.mean || 0).toFixed(2)}`
                        : 'Not completed',
                    completed: steps.precision.completed,
                    data: precisionData
                });
            }

            if (steps.lod_loq) {
                const lodloqData = steps.lod_loq.data || {};
                parameters.push({
                    name: 'LOD/LOQ',
                    key: 'lod_loq',
                    status: steps.lod_loq.passed ? 'PASS' : 'FAIL',
                    details: steps.lod_loq.completed
                        ? `LOD: ${(lodloqData.lod || 0).toFixed(3)}, LOQ: ${(lodloqData.loq || 0).toFixed(3)}`
                        : 'Not completed',
                    completed: steps.lod_loq.completed,
                    data: lodloqData
                });
            }

            let html = '<div class="parameter-review-grid">';
            parameters.forEach((param, index) => {
                const statusClass = param.status === 'PASS' ? 'pass' : (param.completed ? 'fail' : 'pending');
                const hasBeenReviewed = parameterReviews[param.name];
                const reviewStatusClass = hasBeenReviewed ? 'reviewed' : 'not-reviewed';
                const reviewStatusText = hasBeenReviewed 
                    ? `${hasBeenReviewed.decision.toUpperCase()}` 
                    : 'Not Reviewed';

                html += `
                    <div class="parameter-card ${statusClass}">
                        <div class="parameter-header">
                            <h5>${param.name}</h5>
                            <span class="badge status-${statusClass}">${param.status}</span>
                        </div>
                        <div class="parameter-details">
                            <p>${param.details}</p>
                        </div>
                        <div class="parameter-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="reviewParameter('${param.name}', ${index})" ${!param.completed ? 'disabled' : ''}>
                                ${hasBeenReviewed ? 'Edit Review' : 'Review Details'}
                            </button>
                            <span class="review-status ${reviewStatusClass}" id="review-status-${index}">${reviewStatusText}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('parameterReviewsContent').innerHTML = html;
        } catch (error) {
            console.error('Error loading parameter reviews:', error);
            document.getElementById('parameterReviewsContent').innerHTML = 
                '<div class="alert alert-danger">Error loading parameter reviews</div>';
        }
    }

    async function reviewParameter(paramName, paramIndex) {
        currentParameterName = paramName;
        const modal = document.getElementById('parameterModal');
        document.getElementById('parameterTitle').textContent = `Review: ${paramName}`;

        try {
            // Show loading state
            document.getElementById('parameterContent').innerHTML = '<div class="loading">Loading parameter data...</div>';
            modal.classList.add('show');

            // Get the parameter data from validation summary
            const paramKey = paramName.toLowerCase().replace('/', '_');
            const stepData = validationSummary?.validation_steps?.[paramKey === 'lod_loq' ? 'lod_loq' : paramKey];

            if (!stepData || !stepData.data) {
                document.getElementById('parameterContent').innerHTML = 
                    '<div class="alert alert-warning">No data available for this parameter</div>';
                return;
            }

            const data = stepData.data;
            let content = '<div class="parameter-review-details">';

            // Raw data section
            content += '<div class="data-section"><h5>Raw Data</h5>';
            
            if (paramName === 'Linearity' && data.concentrations && data.responses) {
                content += `
                    <div class="data-tables">
                        <table class="data-table">
                            <thead>
                                <tr><th>Concentration</th><th>Response</th></tr>
                            </thead>
                            <tbody>
                                ${data.concentrations.map((conc, i) =>
                                    `<tr><td>${conc}</td><td>${data.responses[i] || '-'}</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (paramName === 'Accuracy' && data.measured_values) {
                content += `
                    <div class="data-tables">
                        <table class="data-table">
                            <thead>
                                <tr><th>Replicate</th><th>Measured Value</th></tr>
                            </thead>
                            <tbody>
                                ${data.measured_values.map((val, i) =>
                                    `<tr><td>${i + 1}</td><td>${val}</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (paramName === 'Precision' && data.replicate_values) {
                content += `
                    <div class="data-tables">
                        <table class="data-table">
                            <thead>
                                <tr><th>Replicate</th><th>Value</th></tr>
                            </thead>
                            <tbody>
                                ${data.replicate_values.map((val, i) =>
                                    `<tr><td>${i + 1}</td><td>${val}</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (paramName === 'LOD/LOQ' && data.blank_responses) {
                content += `
                    <div class="data-tables">
                        <table class="data-table">
                            <thead>
                                <tr><th>Blank #</th><th>Response</th></tr>
                            </thead>
                            <tbody>
                                ${data.blank_responses.map((val, i) =>
                                    `<tr><td>${i + 1}</td><td>${val}</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            content += '</div>';

            // Calculations section
            content += '<div class="calculations-section"><h5>Statistical Results</h5><div class="metrics-display">';
            
            if (paramName === 'Linearity') {
                content += `
                    <div class="metric">Slope: <strong>${(data.slope || 0).toFixed(4)}</strong></div>
                    <div class="metric">Intercept: <strong>${(data.intercept || 0).toFixed(2)}</strong></div>
                    <div class="metric">r¬≤: <strong>${(data.r_squared || 0).toFixed(4)}</strong></div>
                `;
            } else if (paramName === 'Accuracy') {
                content += `
                    <div class="metric">Level: <strong>${data.level || '-'}%</strong></div>
                    <div class="metric">Mean Recovery: <strong>${(data.mean_recovery || 0).toFixed(1)}%</strong></div>
                    <div class="metric">RSD: <strong>${(data.rsd || 0).toFixed(1)}%</strong></div>
                `;
            } else if (paramName === 'Precision') {
                content += `
                    <div class="metric">Mean: <strong>${(data.mean || 0).toFixed(2)}</strong></div>
                    <div class="metric">RSD: <strong>${(data.rsd || 0).toFixed(1)}%</strong></div>
                    <div class="metric">Replicates: <strong>${data.replicate_values?.length || 0}</strong></div>
                `;
            } else if (paramName === 'LOD/LOQ') {
                content += `
                    <div class="metric">LOD: <strong>${(data.lod || 0).toFixed(3)}</strong></div>
                    <div class="metric">LOQ: <strong>${(data.loq || 0).toFixed(3)}</strong></div>
                    <div class="metric">Slope: <strong>${(data.slope || 0).toFixed(4)}</strong></div>
                `;
            }
            content += '</div></div>';

            // Criteria section
            content += '<div class="criteria-section">';
            let criteria = '';
            if (paramName === 'Linearity') {
                criteria = 'ICH Q2(R1): r¬≤ ‚â• 0.99, acceptable intercept';
            } else if (paramName === 'Accuracy') {
                criteria = 'ICH Q2(R1): Recovery 98-102%, RSD < 2%';
            } else if (paramName === 'Precision') {
                criteria = 'ICH Q2(R1): RSD ‚â§ 2% (repeatability)';
            } else if (paramName === 'LOD/LOQ') {
                criteria = 'ICH Q2(R1): S/N ‚â• 3 for LOD, S/N ‚â• 10 for LOQ';
            }
            content += `<h5>Acceptance Criteria</h5><p>${criteria}</p></div>`;

            // Pass/Fail indicator
            const passed = stepData.passed;
            content += `
                <div class="validation-result ${passed ? 'pass' : 'fail'}">
                    <h5>Validation Result: ${passed ? '‚úÖ PASS' : '‚ùå FAIL'}</h5>
                </div>
            `;

            content += '</div>';
            document.getElementById('parameterContent').innerHTML = content;

            // Pre-fill if already reviewed
            if (parameterReviews[paramName]) {
                document.getElementById('parameterDecision').value = parameterReviews[paramName].decision;
                document.getElementById('parameterComments').value = parameterReviews[paramName].comments;
                onParameterDecisionChange();
            } else {
                document.getElementById('parameterDecision').value = '';
                document.getElementById('parameterComments').value = '';
                document.getElementById('deviationSection').style.display = 'none';
            }

        } catch (error) {
            console.error('Error loading parameter details:', error);
            document.getElementById('parameterContent').innerHTML = 
                '<div class="alert alert-danger">Error loading parameter details: ' + (error.message || 'Unknown error') + '</div>';
        }
    }

    function onParameterDecisionChange() {
        const decision = document.getElementById('parameterDecision').value;
        const deviationSection = document.getElementById('deviationSection');

        if (decision === 'reject') {
            deviationSection.style.display = 'block';
        } else {
            deviationSection.style.display = 'none';
        }
    }

    async function submitParameterReview() {
        const decision = document.getElementById('parameterDecision').value;
        const comments = document.getElementById('parameterComments').value;

        if (!decision || !comments.trim()) {
            Utils.showError('Please provide decision and comments');
            return;
        }

        // Store parameter review
        parameterReviews[currentParameterName] = {
            decision,
            comments,
            timestamp: new Date().toISOString()
        };

        Utils.showSuccess(`Parameter ${currentParameterName} reviewed successfully`);
        closeParameterModal();

        // Update review status display
        updateReviewStatuses();
    }

    function updateReviewStatuses() {
        // Refresh the parameter cards to show updated review status
        if (currentProject) {
            loadParameterReviews(currentProject);
        }
    }

    function onFinalDecisionChange() {
        const decision = document.getElementById('finalDecision').value;
        const submitBtn = document.getElementById('submitReviewBtn');

        const confirmCompliance = document.getElementById('confirmCompliance').checked;
        const acknowledgeResp = document.getElementById('acknowledgeResponsibility').checked;
        const comments = document.getElementById('finalComments').value.trim();

        submitBtn.disabled = !(decision && comments && confirmCompliance && acknowledgeResp);
    }

    async function submitFinalReview() {
        const finalDecision = document.getElementById('finalDecision').value;
        const finalComments = document.getElementById('finalComments').value;

        if (!finalDecision || !finalComments.trim()) {
            Utils.showError('Please complete all final review fields');
            return;
        }

        const submitBtn = document.getElementById('submitReviewBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Submitting...';

        try {
            const reviewData = {
                final_decision: finalDecision,
                comments: finalComments,
                parameter_reviews: parameterReviews,
                reviewer_signature: true,
                timestamp: new Date().toISOString()
            };

            const response = await api.submitDetailedReview(currentProject.id, reviewData);

            if (response.status === 200) {
                Utils.showSuccess(response.data.message || 'Project review submitted successfully!');
                
                setTimeout(() => {
                    closeReviewModal();
                    loadProjects();
                }, 1500);
            } else {
                Utils.showError(response.data.error || 'Error submitting review');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Final Review';
            }

        } catch (error) {
            console.error('Error submitting review:', error);
            Utils.showError('Error submitting review: ' + (error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Submit Final Review';
        }
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.remove('show');
    }

    function closeParameterModal() {
        document.getElementById('parameterModal').classList.remove('show');
    }

    function logout() {
        api.logout();
        window.location.href = '/login/';
    }

    loadProjects();
</script>
{% endblock %}
