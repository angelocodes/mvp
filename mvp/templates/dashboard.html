{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Analytical Method Validation MVP{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2>Dashboard</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-3">
                            <div class="card" style="text-align: center; border: 2px solid #0d6efd;">
                                <div class="card-body">
                                    <h3 id="totalProjects" style="font-size: 28px; color: #0d6efd;">0</h3>
                                    <p style="color: #6c757d;">Total Projects</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card" style="text-align: center; border: 2px solid #0dcaf0;">
                                <div class="card-body">
                                    <h3 id="draftProjects" style="font-size: 28px; color: #0dcaf0;">0</h3>
                                    <p style="color: #6c757d;">Draft</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card" style="text-align: center; border: 2px solid #fd7e14;">
                                <div class="card-body">
                                    <h3 id="reviewProjects" style="font-size: 28px; color: #fd7e14;">0</h3>
                                    <p style="color: #6c757d;">In Review</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card" style="text-align: center; border: 2px solid #198754;">
                                <div class="card-body">
                                    <h3 id="approvedProjects" style="font-size: 28px; color: #198754;">0</h3>
                                    <p style="color: #6c757d;">Approved</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2>Recent Projects</h2>
                </div>
                <div class="card-body">
                    <div id="projectsList" style="min-height: 200px;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Loading projects...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadDashboard() {
        try {
            const { data: projects } = await api.getProjects();
            
            let total = projects.length;
            let draft = projects.filter(p => p.status === 'draft').length;
            let review = projects.filter(p => p.status === 'review').length;
            let approved = projects.filter(p => p.status === 'approved').length;

            document.getElementById('totalProjects').textContent = total;
            document.getElementById('draftProjects').textContent = draft;
            document.getElementById('reviewProjects').textContent = review;
            document.getElementById('approvedProjects').textContent = approved;

            const recentProjects = projects.slice(0, 5);
            if (recentProjects.length === 0) {
                document.getElementById('projectsList').innerHTML = '<p style="color: #6c757d;">No projects yet. <a href="/projects/">Create one now</a>.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Method</th><th>Product</th><th>Technique</th><th>Status</th><th>Created</th><th>Action</th></tr></thead><tbody>';
            recentProjects.forEach(project => {
                html += `
                    <tr>
                        <td>${project.method_name}</td>
                        <td>${project.product_name}</td>
                        <td><span class="badge">${project.technique.toUpperCase()}</span></td>
                        <td><span class="badge status-badge status-${project.status}">${project.status}</span></td>
                        <td>${Utils.formatDate(project.created_at)}</td>
                        <td><a href="/projects/${project.id}/" class="btn btn-sm btn-primary">View</a></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            document.getElementById('projectsList').innerHTML = html;
        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">Error loading projects. Please try again.</div>';
        }
    }

    function logout() {
        api.logout();
        window.location.href = '/login/';
    }

    loadDashboard();
</script>
{% endblock %}
